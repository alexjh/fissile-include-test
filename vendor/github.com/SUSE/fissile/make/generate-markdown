#!/bin/sh

set -o errexit

GIT_ROOT=${GIT_ROOT:-$(git rev-parse --show-toplevel)}
# Force an error if $HOME isn't set
home=${HOME:?"HOME isn't set"}

set -o nounset

cd ${GIT_ROOT}
mkdir -p docs/generated
"build/$(go env GOHOSTOS)-$(go env GOHOSTARCH)/fissile" docs markdown -O docs/generated
# Change expanded home directory back to '~'
for x in docs/generated/*.md ; do
    sed -i 's@'${HOME}'@~@g' $x
done
# Then check for date changes only, and revert if that's all we have.
for x in $(git status --porcelain=1 docs/generated/ | cut -b 4-) ; do
    if ! test -e "$x" ; then
        continue # File was deleted, no need to look at diff
    fi
    numUnmatched=$(git diff $x | grep -c -v -E '^[-+]###### Auto generated by spf13/cobra on [0-9]+-[a-zA-Z]+-[0-9]{4}' || true)
    case $numUnmatched in
	0) git checkout -- $x
	    ;;
	*) true #keep diffs in $x
	    ;;
    esac
done
